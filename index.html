<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | spacedolphin's Unity Experience</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=no">

    <!-- Google Analytics 4 (GA4) Tracking -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N4BFSLTHZF"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        // Basic GA4 configuration
        gtag('config', 'G-N4BFSLTHZF', {
            // Enable enhanced measurement for automatic download tracking
            enhanced_measurements: true,
            // Track file downloads automatically
            file_downloads: true
        });
    </script>

    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-functions-compat.min.js"></script>

    <!-- PayPal SDK for dual transactions (no login) -->
    <script src="https://www.paypal.com/sdk/js?client-id=AdgxrQPKeqcirWWUi7HeoPUWGGCs01AxKZnjkKmv8ITkdiWM2N7ABp-jEYNLmQXIy1qfHvqm4JWydSon&currency=USD"></script>

    <style>
        html, body {
            padding: 0;
            margin: 0;
            background: #232323;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #unity-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #232323;
        }

        #unity-canvas {
            background: #232323;
            display: block;
            width: 100vw;
            height: 100vh;
            cursor: default;
        }

/* Loading Screen Styles - 2025 MODERN VERSION */
        #unity-loading-bar {
            position: absolute;
            inset-block-start: 50%;  /* Modern logical property */
            inset-inline-start: 50%; /* Modern logical property */
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            inline-size: min(300px, 90vw);  /* Responsive with modern units */
            block-size: 150px;
            z-index: 1000;
            container-type: inline-size;    /* Modern container query */
        }

        #unity-logo {
            inline-size: 154px;
            block-size: 130px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 154 130"><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="white" font-size="20">Unreality3D</text></svg>') no-repeat center;
            background-size: contain;
        }

        #unity-progress-bar-empty {
            inline-size: 141px;
            block-size: 18px;
            margin-block: 10px;  /* Modern logical margin */
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 141 18"><rect width="141" height="18" fill="none" stroke="%23ffffff" stroke-width="2"/></svg>') no-repeat center;
            background-size: contain;
            position: relative;
            border-radius: 2px;  /* Modern rounded corners */
            overflow: hidden;    /* Clean fill animation */
        }

        #unity-progress-bar-full {
            inline-size: 0%;
            block-size: 100%;
            background: light-dark(#ffffff, #60a5fa);  /* Modern light/dark mode support */
            position: absolute;
            inset: 0 auto 0 0;  /* Modern logical positioning */
            border-radius: inherit;  /* Inherit parent radius */
            transition: inline-size 0.3s cubic-bezier(0.4, 0, 0.2, 1);  /* Modern easing */
        }

        /* Modern container query for responsive loading bar */
        @container (max-width: 200px) {
            #unity-logo {
                inline-size: 100px;
                block-size: 85px;
            }
            #unity-progress-bar-empty {
                inline-size: 120px;
            }
        }

        /* Payment Modal Styles (for dual transactions only) */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .payment-container {
            background: white;
            color: #333;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .payment-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .payment-breakdown {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }

        .split-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }

        .split-total {
            font-size: 18px;
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }

        .creator-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            color: #1976d2;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .payment-container {
                padding: 20px;
                margin: 20px;
            }

            .payment-title {
                font-size: 20px;
            }
        }

        /* Ensure canvas is always fullscreen */
        @media (orientation: landscape) {
            #unity-canvas {
                width: 100vw;
                height: 100vh;
            }
        }

        @media (orientation: portrait) {
            #unity-canvas {
                width: 100vw;
                height: 100vh;
            }
        }

        /* Hide scrollbars */
        ::-webkit-scrollbar {
            display: none;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <!-- Payment Modal (for dual transactions only - no login required) -->
    <div class="payment-modal" id="paymentModal">
        <div class="payment-container">
            <div class="payment-title">üí≥ Complete Your Purchase</div>
            <div id="payment-details"></div>
            <div id="paypal-button-container"></div>
            <button onclick="closePaymentModal()" style="
                background: #ccc;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 15px;
            ">Cancel</button>
        </div>
    </div>

    <!-- Unity WebGL Container -->
    <div id="unity-container">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>

    <script>
        // ENHANCED: Environment Detection with GA4 Tracking for Professional URLs
        function detectEnvironment() {
            const hostname = window.location.hostname.toLowerCase();
            const pathname = window.location.pathname;

            // Professional URL pattern: username.unreality3d.com/project/
            if (hostname.endsWith('.unreality3d.com') && hostname !== 'unreality3d.com') {
                const creatorUsername = hostname.replace('.unreality3d.com', '');
                const projectName = pathname.split('/').filter(p => p.length > 0)[0] || 'main';
                
                console.log('Professional URL detected:', hostname);
                
                // ADDED: Send GA4 custom event for creator project visit
                gtag('event', 'creator_project_visit', {
                    creator_name: creatorUsername,
                    project_name: projectName,
                    content_type: 'unity_webgl',
                    platform_section: 'creator_content'
                });
                
                return {
                    type: 'professional',
                    isProduction: true,
                    projectId: 'unreality3d',
                    creatorUsername: creatorUsername,
                    projectName: projectName
                };
            }

            // Firebase hosting detection
            if (hostname.includes('unreality3d.web.app') || hostname.includes('unreality3d.firebaseapp.com')) {
                gtag('event', 'platform_visit', {
                    content_type: 'platform_hosting',
                    platform_section: 'firebase_hosting'
                });
                return { type: 'firebase', isProduction: true, projectId: 'unreality3d' };
            }

            if (hostname.includes('unreality3d2025.web.app') || hostname.includes('unreality3d2025.firebaseapp.com')) {
                gtag('event', 'platform_visit', {
                    content_type: 'platform_hosting',
                    platform_section: 'firebase_development'
                });
                return { type: 'firebase', isProduction: false, projectId: 'unreality3d2025' };
            }

            // GitHub Pages detection
            if (hostname.includes('github.io')) {
                gtag('event', 'platform_visit', {
                    content_type: 'github_pages',
                    platform_section: 'direct_github'
                });
                return { type: 'github-pages', isProduction: true, projectId: 'unreality3d' };
            }

            // Default fallback
            gtag('event', 'platform_visit', {
                content_type: 'unknown_hosting',
                platform_section: 'fallback'
            });
            return { type: 'creator', isProduction: true, projectId: 'unreality3d' };
        }

        // ENHANCED: Detect environment with GA4 tracking
        const environment = detectEnvironment();

        // Global variables
        let unityInstance = null;
        let functions = null;
        let currentPaymentData = null;

        // RESTORED: SECURE Firebase configuration fetching from backend
        async function initializeFirebase() {
            try {
                const configEndpoint = environment.isProduction
                    ? 'https://us-central1-unreality3d.cloudfunctions.net/getFirebaseConfig'
                    : 'https://us-central1-unreality3d2025.cloudfunctions.net/getFirebaseConfig';

                const response = await fetch(configEndpoint);
                if (!response.ok) {
                    throw new Error('Failed to fetch Firebase configuration');
                }

                const firebaseConfig = await response.json();

                console.log('Environment:', environment.type);
                console.log('Production:', environment.isProduction);
                console.log('Firebase Project:', firebaseConfig.projectId);

                if (environment.type === 'professional') {
                    console.log('Creator:', environment.creatorUsername);
                    console.log('Project:', environment.projectName);
                }

                // Initialize Firebase with secure config
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }

                // Initialize Firebase Functions only (no auth required for dual transactions)
                functions = firebase.functions();

                // ADDED: Track Firebase initialization success
                gtag('event', 'firebase_initialized', {
                    project_id: firebaseConfig.projectId,
                    environment_type: environment.type
                });

                // Load Unity immediately (no auth check needed)
                loadUnity();

            } catch (error) {
                console.error('Firebase initialization failed:', error);

                // ADDED: Track Firebase initialization failure
                gtag('event', 'firebase_init_failed', {
                    error_message: error.message,
                    environment_type: environment.type
                });

                // Fallback: Load Unity without Firebase
                loadUnity();
            }
        }

        // ===== UNITY LOADING FUNCTION - RESPONSIVE FULLSCREEN =====
        function loadUnity() {
            // ADDED: Track Unity loading start
            gtag('event', 'unity_load_start', {
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main',
                content_type: 'unity_webgl'
            });

            var container = document.querySelector("#unity-container");
            var canvas = document.querySelector("#unity-canvas");
            var loadingBar = document.querySelector("#unity-loading-bar");
            var progressBarFull = document.querySelector("#unity-progress-bar-full");
            var warningBanner = document.querySelector("#unity-warning");

            function unityShowBanner(msg, type) {
                console.log('Unity Banner:', msg, type);
                
                // ADDED: Track Unity loading issues
                if (type === 'error') {
                    gtag('event', 'unity_load_error', {
                        error_message: msg,
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main'
                    });
                }
                
                function updateBannerVisibility() {
                    warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
                }
                var div = document.createElement('div');
                div.innerHTML = msg;
                warningBanner.appendChild(div);
                if (type == 'error') div.style = 'background: red; padding: 5px;';
                else {
                    if (type == 'warning') div.style = 'background: yellow; color: black; padding: 5px;';
                    setTimeout(function() {
                        warningBanner.removeChild(div);
                        updateBannerVisibility();
                    }, 5000);
                }
                updateBannerVisibility();
            }

            var buildUrl = "Build";
            var loaderUrl = buildUrl + "/e837da0becdf58b8c840d15a4c5e8587.loader.js?v=1753237134594";
            var config = {
                dataUrl: buildUrl + "/3667e872e61f798e565e8f2148266c0d.data?v=1753237134594",
                frameworkUrl: buildUrl + "/ae69ce2511a62d15192ae464d655d470.framework.js?v=1753237134594",
                codeUrl: buildUrl + "/aabf4b8a86d184eb0d363f62b7eeb653.wasm?v=1753237134594",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "spacedolphin",
                productName: "spacedolphin's Unity Experience",
                productVersion: "1.0.0",
                showBanner: unityShowBanner,
                cacheControl: function (url) {
                    // CRITICAL FIX: Handle undefined URL parameter
                    if (!url || typeof url !== 'string') {
                        console.warn('Unity cacheControl called with invalid URL:', url);
                        return "no-store";
                    }
                    if (url.match(/\.data/) || url.match(/\.wasm/) || url.match(/\.framework\.js/)) {
                        return "must-revalidate";
                    }
                    return "no-store";
                }
            };

            // Remove the loading bar on mobile
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                container.className = "unity-mobile";
                config.devicePixelRatio = 1;
                unityShowBanner('WebGL builds are not supported on mobile devices.');
                
                // ADDED: Track mobile device access
                gtag('event', 'mobile_access_attempt', {
                    device_type: 'mobile',
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            } else {
                canvas.style.width = "100vw";
                canvas.style.height = "100vh";
            }

            loadingBar.style.display = "block";

            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    progressBarFull.style.width = 100 * progress + "%";
                    
                    // ADDED: Track loading progress milestones
                    if (progress === 0.5) {
                        gtag('event', 'unity_load_50_percent', {
                            creator_name: environment.creatorUsername || 'platform',
                            project_name: environment.projectName || 'main'
                        });
                    }
                }).then((instance) => {
                    unityInstance = instance;
                    loadingBar.style.display = "none";
                    console.log('üéÆ Unity loaded - Dual transaction system ready');
                    
                    // ADDED: Track successful Unity load
                    gtag('event', 'unity_load_complete', {
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main',
                        load_time_ms: Date.now() - performance.timing.navigationStart
                    });
                    
                }).catch((message) => {
                    // ADDED: Track Unity load failure
                    gtag('event', 'unity_load_failed', {
                        error_message: message,
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main'
                    });
                    alert(message);
                });
            };
            
            script.onerror = () => {
                // ADDED: Track script load failure
                gtag('event', 'unity_script_load_failed', {
                    script_url: loaderUrl,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            };
            
            document.body.appendChild(script);
        }

        // ===== DUAL TRANSACTION SYSTEM (NO LOGIN REQUIRED) WITH GA4 TRACKING =====
        window.UnityStartDualTransaction = function(itemName, itemDescription, totalAmount, transactionId) {
            console.log('üí≥ Starting dual transaction:', {
                itemName,
                itemDescription,
                totalAmount,
                transactionId
            });

            // ADDED: Track payment initiation
            gtag('event', 'begin_checkout', {
                currency: 'USD',
                value: parseFloat(totalAmount),
                item_name: itemName,
                item_category: 'unity_content',
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main',
                transaction_id: transactionId
            });

            try {
                // Store payment data
                currentPaymentData = {
                    itemName,
                    itemDescription,
                    totalAmount: parseFloat(totalAmount),
                    transactionId,
                    creatorAmount: Math.round(parseFloat(totalAmount) * 0.95 * 100) / 100,
                    platformAmount: Math.round(parseFloat(totalAmount) * 0.05 * 100) / 100
                };

                // Show payment modal with breakdown
                showPaymentModal();

            } catch (error) {
                console.error('‚ùå Dual transaction setup failed:', error);
                
                // ADDED: Track payment setup failure
                gtag('event', 'payment_setup_failed', {
                    error_message: error.message,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
                
                if (unityInstance) {
                    unityInstance.SendMessage('PayPalDualTransaction', 'OnPaymentComplete', 'false');
                }
            }
        };

        function showPaymentModal() {
            if (!currentPaymentData) return;

            const modal = document.getElementById('paymentModal');
            const detailsDiv = document.getElementById('payment-details');
            const buttonContainer = document.getElementById('paypal-button-container');

            // Clear previous content
            detailsDiv.innerHTML = '';
            buttonContainer.innerHTML = '';

            // Create payment details
            detailsDiv.innerHTML = `
                <h3>${currentPaymentData.itemName}</h3>
                <p>${currentPaymentData.itemDescription}</p>
                
                <div class="payment-breakdown">
                    <h4>üí∞ Payment Breakdown</h4>
                    <div class="split-row">
                        <span>üíé Creator (95%):</span>
                        <strong>$${currentPaymentData.creatorAmount.toFixed(2)}</strong>
                    </div>
                    <div class="split-row">
                        <span>üèóÔ∏è Platform (5%):</span>
                        <span>$${currentPaymentData.platformAmount.toFixed(2)}</span>
                    </div>
                    <div class="split-row split-total">
                        <strong>Total:</strong>
                        <strong>$${currentPaymentData.totalAmount.toFixed(2)}</strong>
                    </div>
                </div>
                
                <div class="creator-info">
                    <p style="margin: 0;">
                        <strong>üîí Secure Dual Transaction</strong><br>
                        Your payment automatically splits between creator and platform.
                        No account creation required!
                    </p>
                </div>
            `;

            // Create PayPal button
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: currentPaymentData.totalAmount.toFixed(2)
                            },
                            description: `${currentPaymentData.itemName} - Unreality3D Creator Content`
                        }],
                        application_context: {
                            brand_name: 'Unreality3D',
                            user_action: 'PAY_NOW'
                        }
                    });
                },
                
                onApprove: async function(data, actions) {
                    try {
                        // Capture the payment
                        const order = await actions.order.capture();
                        console.log('‚úÖ PayPal payment captured:', order);
                        
                        // ADDED: Track successful payment
                        gtag('event', 'purchase', {
                            transaction_id: currentPaymentData.transactionId,
                            value: currentPaymentData.totalAmount,
                            currency: 'USD',
                            creator_name: environment.creatorUsername || 'platform',
                            project_name: environment.projectName || 'main',
                            item_name: currentPaymentData.itemName,
                            creator_amount: currentPaymentData.creatorAmount,
                            platform_amount: currentPaymentData.platformAmount
                        });
                        
                        // Process dual transaction via Firebase (if available)
                        if (functions) {
                            await processDualTransaction(order);
                        } else {
                            // Fallback: notify Unity of success
                            showPaymentStatus('‚úÖ Payment successful!', 'success');
                            setTimeout(() => {
                                closePaymentModal();
                                if (unityInstance) {
                                    unityInstance.SendMessage('PayPalDualTransaction', 'OnPaymentComplete', 'true');
                                }
                            }, 2000);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Payment processing failed:', error);
                        
                        // ADDED: Track payment failure
                        gtag('event', 'payment_failed', {
                            error_message: error.message,
                            creator_name: environment.creatorUsername || 'platform',
                            project_name: environment.projectName || 'main',
                            transaction_id: currentPaymentData.transactionId
                        });
                        
                        showPaymentStatus('‚ùå Payment failed: ' + error.message, 'error');
                    }
                },
                
                onError: function(err) {
                    console.error('‚ùå PayPal error:', err);
                    
                    // ADDED: Track PayPal errors
                    gtag('event', 'paypal_error', {
                        error_details: JSON.stringify(err),
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main'
                    });
                    
                    showPaymentStatus('‚ùå Payment error occurred', 'error');
                },
                
                onCancel: function(data) {
                    console.log('‚ö†Ô∏è Payment cancelled');
                    
                    // ADDED: Track payment cancellation
                    gtag('event', 'payment_cancelled', {
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main',
                        transaction_id: currentPaymentData.transactionId
                    });
                    
                    closePaymentModal();
                    if (unityInstance) {
                        unityInstance.SendMessage('PayPalDualTransaction', 'OnPaymentComplete', 'false');
                    }
                }
                
            }).render('#paypal-button-container');

            modal.style.display = 'flex';
        }

        async function processDualTransaction(paypalOrder) {
            try {
                showPaymentStatus('üîÑ Processing dual transaction...', 'info');
                
                // Call Firebase function for dual transaction
                const createDualTransaction = functions.httpsCallable('createDualTransaction');
                const result = await createDualTransaction({
                    itemName: currentPaymentData.itemName,
                    itemDescription: currentPaymentData.itemDescription,
                    totalAmount: currentPaymentData.totalAmount,
                    transactionId: currentPaymentData.transactionId,
                    paypalOrderId: paypalOrder.id
                });

                if (result.data && result.data.success) {
                    console.log('‚úÖ Dual transaction completed:', result.data);
                    
                    // ADDED: Track dual transaction success
                    gtag('event', 'dual_transaction_complete', {
                        transaction_id: currentPaymentData.transactionId,
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main',
                        creator_amount: currentPaymentData.creatorAmount,
                        platform_amount: currentPaymentData.platformAmount
                    });
                    
                    showPaymentStatus('‚úÖ Payment successful! Funds distributed.', 'success');
                    
                    setTimeout(() => {
                        closePaymentModal();
                        if (unityInstance) {
                            unityInstance.SendMessage('PayPalDualTransaction', 'OnPaymentComplete', 'true');
                        }
                    }, 2000);
                    
                } else {
                    throw new Error(result.data?.message || 'Dual transaction failed');
                }

            } catch (error) {
                console.error('‚ùå Dual transaction failed:', error);
                
                // ADDED: Track dual transaction failure
                gtag('event', 'dual_transaction_failed', {
                    error_message: error.message,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
                
                showPaymentStatus('‚ùå Transaction processing failed: ' + error.message, 'error');
            }
        }

        function showPaymentStatus(message, type) {
            const detailsDiv = document.getElementById('payment-details');
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                padding: 15px;
                margin: 15px 0;
                border-radius: 5px;
                font-weight: bold;
                ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : ''}
                ${type === 'error' ? 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;' : ''}
                ${type === 'info' ? 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;' : ''}
            `;
            statusDiv.textContent = message;
            
            // Replace existing status or add new one
            const existingStatus = detailsDiv.querySelector('.status-message');
            if (existingStatus) {
                existingStatus.replaceWith(statusDiv);
            } else {
                statusDiv.className = 'status-message';
                detailsDiv.appendChild(statusDiv);
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentPaymentData = null;
        }

        // ===== UNITY BRIDGE FUNCTIONS (SIMPLIFIED) WITH GA4 TRACKING =====
        
        // No authentication required for dual transactions
        window.UnityCheckAuthenticationStatus = function() {
            // ADDED: Track authentication check
            gtag('event', 'auth_check', {
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main',
                auth_required: false
            });
            
            if (unityInstance) {
                unityInstance.SendMessage('PayPalDualTransaction', 'OnAuthenticationChecked', 'true');
            }
        };

        // Legacy payment function (redirects to dual transaction)
        window.UnityRequestPayment = function(contentId, amount) {
            console.log('üîÑ Legacy payment request redirected to dual transaction');
            
            // ADDED: Track legacy payment redirect
            gtag('event', 'legacy_payment_redirect', {
                content_id: contentId,
                amount: amount,
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main'
            });
            
            window.UnityStartDualTransaction(
                'Creator Content',
                'Premium content purchase',
                amount,
                'legacy_' + Date.now()
            );
        };

        // Test functions
        window.UnityCallTestFunction = function() {
            console.log('üß™ Unity test function called');

            // ADDED: Track test function calls
            gtag('event', 'unity_test_function', {
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main'
            });

            if (functions) {
                const testFunction = functions.httpsCallable('testFunction');
                testFunction({ message: 'Hello from Unity!' })
                    .then((result) => {
                        console.log('‚úÖ Test function result:', result.data);
                        
                        // ADDED: Track successful test
                        gtag('event', 'unity_test_success', {
                            creator_name: environment.creatorUsername || 'platform',
                            project_name: environment.projectName || 'main'
                        });
                        
                        if (unityInstance) {
                            unityInstance.SendMessage('FirebaseIntegration', 'OnTestComplete', JSON.stringify(result.data));
                        }
                    })
                    .catch((error) => {
                        console.error('‚ùå Test function failed:', error);
                        
                        // ADDED: Track failed test
                        gtag('event', 'unity_test_failed', {
                            error_message: error.message,
                            creator_name: environment.creatorUsername || 'platform',
                            project_name: environment.projectName || 'main'
                        });
                        
                        if (unityInstance) {
                            unityInstance.SendMessage('FirebaseIntegration', 'OnTestComplete', JSON.stringify({error: error.message}));
                        }
                    });
            } else {
                console.log('‚ö†Ô∏è Firebase Functions not available');
                
                // ADDED: Track Firebase unavailable
                gtag('event', 'firebase_unavailable', {
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
                
                if (unityInstance) {
                    unityInstance.SendMessage('FirebaseIntegration', 'OnTestComplete', 'Firebase not available');
                }
            }
        };

        // ADDED: Custom download tracking function for your existing trackDownload calls
        window.trackDownload = function(source) {
            console.log('üì• Template download tracked:', source);
            
            // Send to GA4 with enhanced tracking
            gtag('event', 'file_download', {
                file_name: 'u3d-template',
                download_source: source,
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main',
                template_version: 'latest'
            });
        };

        // Responsive canvas handling
        function handleResize() {
            if (unityInstance) {
                const canvas = document.querySelector("#unity-canvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                // ADDED: Track resize events for analytics
                gtag('event', 'unity_canvas_resize', {
                    new_width: window.innerWidth,
                    new_height: window.innerHeight,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            }
        }

        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', handleResize);

        // Prevent default touch behaviors on canvas
        document.addEventListener('touchstart', function(e) {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchend', function(e) {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
            }
        }, { passive: false });

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                        
                        // ADDED: Track service worker success
                        gtag('event', 'service_worker_registered', {
                            creator_name: environment.creatorUsername || 'platform',
                            project_name: environment.projectName || 'main'
                        });
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                        
                        // ADDED: Track service worker failure
                        gtag('event', 'service_worker_failed', {
                            error_message: err.message,
                            creator_name: environment.creatorUsername || 'platform',
                            project_name: environment.projectName || 'main'
                        });
                    });
            });
        }

        // ADDED: Track page engagement and interactions
        
        // Track time spent on page
        let pageStartTime = Date.now();
        let engagementTracked = false;
        
        // Track 30 second engagement
        setTimeout(() => {
            if (!engagementTracked) {
                gtag('event', 'page_engagement_30s', {
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main',
                    engagement_time_msec: 30000
                });
                engagementTracked = true;
            }
        }, 30000);
        
        // Track page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                gtag('event', 'page_hidden', {
                    time_on_page: Date.now() - pageStartTime,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            } else {
                gtag('event', 'page_visible', {
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
                pageStartTime = Date.now(); // Reset timer
            }
        });

        // Track when user leaves page
        window.addEventListener('beforeunload', function() {
            gtag('event', 'page_exit', {
                total_time_on_page: Date.now() - pageStartTime,
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main'
            });
        });

        // RESTORED: Initialize Firebase and load Unity
        initializeFirebase();

        console.log('üí≥ Dual Transaction WebGL Template loaded');
        console.log('üéØ Revenue split: 95% Creator, 5% Platform');
        console.log('üöÄ No login required - direct payment processing');
        console.log('üåê Professional URL support restored');
        console.log('üìä GA4 Analytics tracking enabled');
        
        // ADDED: Track template initialization
        gtag('event', 'template_initialized', {
            template_version: 'sophisticated_v2025',
            creator_name: environment.creatorUsername || 'platform',
            project_name: environment.projectName || 'main',
            features: ['dual_transactions', 'firebase', 'pwa', 'ga4_tracking']
        });
    </script>
</body>
</html>